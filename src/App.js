import React, {
  useEffect, lazy, Suspense, useState,
} from 'react'
import { Switch, Route, useLocation } from 'react-router-dom'
import routes from 'routes'
import { useDispatch, useSelector } from 'react-redux'
import { useAlert } from '@blaumaus/react-alert'
import cx from 'clsx'
import _some from 'lodash/some'
import _includes from 'lodash/includes'
import 'dayjs/locale/ru'
import 'dayjs/locale/uk'

import Header from 'components/Header'
import Footer from 'components/Footer'
import Loader from 'ui/Loader'

import ScrollToTop from 'hoc/ScrollToTop'
import Selfhosted from 'hoc/Selfhosted'
import { isSelfhosted } from 'redux/constants'
import { getAccessToken } from 'utils/accessToken'
import { authActions } from 'redux/actions/auth'
import { errorsActions } from 'redux/actions/errors'
import { alertsActions } from 'redux/actions/alerts'
import UIActions from 'redux/actions/ui'
import { authMe } from './api'

const MainPage = lazy(() => import('pages/MainPage'))
const SignUp = lazy(() => import('pages/Auth/Signup'))
const SignIn = lazy(() => import('pages/Auth/Signin'))
const ForgotPassword = lazy(() => import('pages/Auth/ForgotPassword'))
const CreateNewPassword = lazy(() => import('pages/Auth/CreateNewPassword'))
const Dashboard = lazy(() => import('pages/Dashboard'))
const Contact = lazy(() => import('pages/Contact'))
const Docs = lazy(() => import('pages/Docs'))
const Features = lazy(() => import('pages/Features'))
const UserSettings = lazy(() => import('pages/UserSettings'))
const VerifyEmail = lazy(() => import('pages/Auth/VerifyEmail'))
const ProjectSettings = lazy(() => import('pages/Project/Settings'))
const ViewProject = lazy(() => import('pages/Project/View'))
const Billing = lazy(() => import('pages/Billing'))
const Privacy = lazy(() => import('pages/Privacy'))
const ConfirmShare = lazy(() => import('pages/Project/ConfirmShare'))
const Terms = lazy(() => import('pages/Terms'))
const NotFound = lazy(() => import('pages/NotFound'))
const About = lazy(() => import('pages/About'))

const minimalFooterPages = [
  '/projects', '/dashboard', '/settings', '/contact',
]

const Fallback = ({ isMinimalFooter }) => {
  const [showLoader, setShowLoader] = useState(false)

  useEffect(() => {
    let isMounted = true

    setTimeout(() => {
      if (isMounted) {
        setShowLoader(true)
      }
    }, 1000)

    return () => {
      isMounted = false
    }
  }, [])

  return (
    <div className={cx('bg-gray-50 dark:bg-gray-800', { 'min-h-page': !isMinimalFooter, 'min-h-min-footer': isMinimalFooter })}>
      {showLoader && (
        <Loader />
      )}
    </div>
  )
}

const App = () => {
  const dispatch = useDispatch()
  const location = useLocation()
  const alert = useAlert()
  const { loading, authenticated } = useSelector(state => state.auth)
  const { theme } = useSelector(state => state.ui.theme)
  const { error } = useSelector(state => state.errors)
  const { message, type } = useSelector(state => state.alerts)
  const accessToken = getAccessToken()

  useEffect(() => {
    const eventCallback = (data) => {
      dispatch(UIActions.setPaddleLastEvent(data))
    }
    // eslint-disable-next-line no-use-before-define
    const interval = setInterval(paddleSetup, 200)

    function paddleSetup() {
      if (isSelfhosted) {
        clearInterval(interval)
      } else if (window.Paddle) {
        window.Paddle.Setup({
          vendor: 139393,
          eventCallback,
        })
        clearInterval(interval)
      }
    }
  }, []) // eslint-disable-line

  const createSnowFlake = () => {
    const snowFlake = document.createElement('i')
    snowFlake.setAttribute('class', 'snowflake')
    snowFlake.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    // viewBox="0 0 512 512"
    snowFlake.setAttribute('viewBox', '0 0 512 512')
    snowFlake.innerHTML = `<svg width="100%" height="100%" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M273.856 241.072L260 233.072C258.784 232.37 257.404 232 256 232C254.596 232 253.216 232.37 252 233.072L238.144 241.072C236.928 241.774 235.918 242.784 235.216 244C234.514 245.216 234.144 246.596 234.144 248V264C234.144 265.404 234.514 266.784 235.216 268C235.918 269.216 236.928 270.226 238.144 270.928L252 278.928C253.216 279.63 254.596 280 256 280C257.404 280 258.784 279.63 260 278.928L273.856 270.928C275.072 270.226 276.082 269.216 276.784 268C277.486 266.784 277.856 265.404 277.856 264V248C277.856 246.596 277.486 245.216 276.784 244C276.082 242.784 275.072 241.774 273.856 241.072ZM261.856 259.381L256 262.763L250.144 259.381V252.619L256 249.237L261.856 252.619V259.381ZM460.916 365.069L444.416 355.541L448.543 352.816C450.298 351.64 451.517 349.818 451.933 347.747C452.35 345.676 451.93 343.524 450.766 341.761C449.602 339.998 447.787 338.768 445.719 338.337C443.651 337.907 441.497 338.313 439.726 339.465L428.926 346.597L416.7 339.541L435.755 326.96C436.635 326.383 437.393 325.637 437.984 324.767C438.576 323.896 438.989 322.917 439.202 321.886C439.415 320.855 439.422 319.793 439.223 318.759C439.024 317.725 438.623 316.741 438.043 315.863C437.463 314.985 436.715 314.229 435.843 313.64C434.97 313.051 433.99 312.64 432.959 312.431C431.927 312.222 430.865 312.218 429.832 312.42C428.799 312.622 427.816 313.025 426.939 313.608L401.209 330.6L390.014 324.137L418.445 308.354C420.284 307.316 421.639 305.593 422.212 303.56C422.786 301.528 422.533 299.351 421.508 297.504C420.483 295.658 418.769 294.291 416.741 293.703C414.712 293.115 412.534 293.353 410.68 294.365L373.855 314.808L363.01 308.546L375.467 302.387C376.416 301.925 377.264 301.281 377.962 300.49C378.661 299.7 379.196 298.779 379.537 297.781C379.878 296.783 380.019 295.727 379.95 294.674C379.882 293.621 379.606 292.593 379.138 291.647C378.671 290.702 378.021 289.858 377.226 289.164C376.431 288.471 375.506 287.942 374.506 287.607C373.506 287.272 372.449 287.138 371.397 287.214C370.345 287.289 369.318 287.571 368.375 288.045L360 292.183V219.813L368.375 223.954C369.318 224.428 370.345 224.71 371.397 224.785C372.449 224.861 373.506 224.727 374.506 224.392C375.506 224.057 376.431 223.528 377.226 222.835C378.021 222.141 378.671 221.297 379.138 220.352C379.606 219.406 379.882 218.378 379.95 217.325C380.019 216.272 379.878 215.216 379.537 214.218C379.196 213.22 378.661 212.299 377.962 211.509C377.264 210.718 376.416 210.074 375.467 209.612L363.01 203.453L373.855 197.191L410.68 217.634C411.599 218.16 412.614 218.497 413.665 218.628C414.716 218.758 415.782 218.679 416.802 218.394C417.823 218.109 418.776 217.625 419.607 216.969C420.438 216.312 421.131 215.498 421.645 214.572C422.159 213.646 422.484 212.627 422.602 211.574C422.719 210.522 422.626 209.457 422.328 208.44C422.03 207.424 421.534 206.477 420.867 205.654C420.201 204.831 419.377 204.148 418.445 203.646L390.014 187.862L401.209 181.399L426.939 198.388C427.816 198.971 428.799 199.374 429.832 199.576C430.865 199.778 431.927 199.774 432.959 199.565C433.99 199.356 434.97 198.945 435.843 198.356C436.715 197.767 437.463 197.011 438.043 196.133C438.623 195.255 439.024 194.271 439.223 193.237C439.422 192.203 439.415 191.141 439.202 190.11C438.989 189.079 438.576 188.1 437.984 187.229C437.393 186.359 436.635 185.613 435.755 185.036L416.7 172.455L428.921 165.399L439.721 172.531C440.598 173.118 441.582 173.526 442.616 173.732C443.651 173.937 444.717 173.936 445.751 173.728C446.785 173.52 447.768 173.109 448.643 172.52C449.518 171.93 450.268 171.174 450.85 170.293C451.431 169.413 451.832 168.426 452.031 167.39C452.23 166.354 452.221 165.289 452.006 164.256C451.791 163.223 451.374 162.243 450.779 161.371C450.184 160.5 449.422 159.756 448.538 159.18L444.411 156.455L460.911 146.927C461.828 146.406 462.633 145.708 463.28 144.874C463.926 144.04 464.401 143.087 464.678 142.069C464.954 141.05 465.026 139.988 464.89 138.941C464.754 137.895 464.413 136.886 463.885 135.972C463.358 135.059 462.655 134.258 461.816 133.618C460.978 132.977 460.022 132.508 459.002 132.238C457.982 131.969 456.919 131.903 455.873 132.046C454.828 132.189 453.821 132.537 452.911 133.071L436.411 142.599L436.111 137.663C435.973 135.553 435.005 133.584 433.42 132.186C431.834 130.787 429.759 130.073 427.649 130.2C425.538 130.327 423.564 131.284 422.157 132.862C420.75 134.44 420.025 136.511 420.14 138.622L420.915 151.543L408.7 158.6L407.332 135.808C407.269 134.759 407 133.733 406.541 132.788C406.081 131.844 405.44 130.999 404.654 130.301C403.868 129.604 402.952 129.069 401.959 128.726C400.966 128.383 399.915 128.239 398.867 128.301C397.818 128.364 396.792 128.633 395.847 129.093C394.902 129.552 394.057 130.194 393.36 130.98C392.663 131.766 392.128 132.681 391.784 133.674C391.441 134.667 391.297 135.718 391.36 136.767L393.208 167.544L382.013 174.007L382.561 141.494C382.597 139.372 381.788 137.323 380.313 135.798C378.838 134.272 376.817 133.395 374.696 133.359C372.574 133.324 370.525 134.132 368.999 135.608C367.474 137.083 366.597 139.103 366.561 141.225L365.853 183.337L355.01 189.6L355.905 175.732C355.973 174.684 355.833 173.632 355.494 172.638C355.155 171.643 354.624 170.725 353.931 169.936C353.237 169.147 352.395 168.502 351.452 168.039C350.509 167.575 349.484 167.302 348.436 167.234C347.388 167.166 346.336 167.306 345.342 167.645C344.347 167.984 343.429 168.515 342.64 169.209C341.851 169.902 341.206 170.744 340.743 171.687C340.279 172.63 340.006 173.655 339.938 174.703L339.338 184.029L276.661 147.84L284.438 142.656C286.191 141.474 287.404 139.646 287.813 137.571C288.222 135.497 287.794 133.345 286.621 131.586C285.448 129.826 283.626 128.603 281.554 128.183C279.482 127.763 277.327 128.18 275.562 129.344L264 137.052V124.53L300.116 102.86C301.935 101.768 303.247 99.9987 303.761 97.9403C304.276 95.8819 303.952 93.7034 302.86 91.884C301.768 90.0646 299.999 88.7534 297.94 88.2388C295.882 87.7242 293.703 88.0484 291.884 89.14L264 105.871V92.944L291.578 79.155C292.526 78.6901 293.373 78.0422 294.069 77.2486C294.765 76.455 295.298 75.5314 295.636 74.5311C295.973 73.5307 296.11 72.4734 296.037 71.4201C295.964 70.3668 295.683 69.3383 295.211 68.394C294.739 67.4497 294.084 66.6081 293.285 65.918C292.486 65.2278 291.559 64.7026 290.556 64.3727C289.553 64.0428 288.494 63.9147 287.442 63.9957C286.389 64.0768 285.363 64.3654 284.422 64.845L264 75.056V60.944L275.578 55.155C276.526 54.6901 277.373 54.0422 278.069 53.2486C278.765 52.455 279.298 51.5314 279.636 50.5311C279.973 49.5307 280.11 48.4734 280.037 47.4201C279.964 46.3668 279.683 45.3383 279.211 44.394C278.739 43.4497 278.084 42.6081 277.285 41.918C276.486 41.2278 275.559 40.7026 274.556 40.3727C273.553 40.0428 272.494 39.9147 271.442 39.9957C270.389 40.0768 269.363 40.3654 268.422 40.845L264 43.056V24C264 21.8783 263.157 19.8434 261.657 18.3431C260.157 16.8429 258.122 16 256 16C253.878 16 251.843 16.8429 250.343 18.3431C248.843 19.8434 248 21.8783 248 24V43.056L243.578 40.845C241.683 39.9156 239.497 39.773 237.497 40.4482C235.497 41.1234 233.845 42.5618 232.901 44.4498C231.956 46.3378 231.797 48.5225 232.456 50.5277C233.116 52.5329 234.541 54.1962 236.422 55.155L248 60.944V75.056L227.578 64.845C225.683 63.9156 223.497 63.773 221.497 64.4482C219.497 65.1234 217.845 66.5618 216.901 68.4498C215.956 70.3378 215.797 72.5225 216.456 74.5277C217.116 76.5329 218.541 78.1962 220.422 79.155L248 92.944V105.871L220.116 89.14C218.297 88.0484 216.118 87.7242 214.06 88.2388C212.001 88.7534 210.232 90.0646 209.14 91.884C208.048 93.7034 207.724 95.8819 208.239 97.9403C208.753 99.9987 210.065 101.768 211.884 102.86L248 124.53V137.052L236.438 129.344C235.564 128.755 234.582 128.344 233.549 128.135C232.516 127.926 231.451 127.924 230.417 128.127C229.383 128.331 228.399 128.738 227.522 129.323C226.646 129.908 225.893 130.661 225.308 131.538C224.724 132.415 224.318 133.399 224.115 134.434C223.911 135.468 223.915 136.532 224.124 137.566C224.333 138.599 224.745 139.58 225.335 140.454C225.925 141.328 226.682 142.076 227.562 142.656L235.339 147.84L172.663 184.026L172.063 174.7C171.995 173.652 171.722 172.627 171.258 171.684C170.795 170.741 170.15 169.899 169.361 169.206C168.572 168.512 167.654 167.981 166.659 167.642C165.665 167.303 164.613 167.163 163.565 167.231C162.517 167.299 161.492 167.572 160.549 168.036C159.606 168.499 158.764 169.144 158.071 169.933C157.377 170.722 156.846 171.64 156.507 172.635C156.168 173.629 156.028 174.681 156.096 175.729L156.996 189.597L146.151 183.336L145.443 141.224C145.407 139.102 144.53 137.082 143.005 135.607C141.479 134.131 139.43 133.323 137.309 133.359C135.187 133.394 133.166 134.271 131.691 135.797C130.216 137.322 129.407 139.371 129.443 141.493L129.991 174.006L118.796 167.543L120.644 136.766C120.771 134.648 120.052 132.566 118.644 130.979C117.236 129.391 115.256 128.428 113.138 128.301C111.02 128.173 108.938 128.893 107.35 130.3C105.763 131.708 104.799 133.689 104.672 135.807L103.3 158.6L91.08 151.544L91.855 138.623C91.9704 136.512 91.2453 134.441 89.8383 132.863C88.4314 131.285 86.4569 130.328 84.3465 130.201C82.236 130.074 80.1612 130.788 78.5755 132.187C76.9898 133.585 76.0222 135.554 75.884 137.664L75.584 142.6L59.084 133.072C58.1739 132.538 57.1672 132.19 56.1218 132.047C55.0765 131.904 54.0133 131.97 52.9933 132.239C51.9733 132.509 51.0167 132.978 50.1786 133.619C49.3405 134.259 48.6375 135.06 48.1099 135.973C47.5824 136.887 47.2408 137.896 47.1048 138.942C46.9688 139.989 47.0411 141.051 47.3176 142.07C47.594 143.088 48.0691 144.041 48.7155 144.875C49.3619 145.709 50.1669 146.407 51.084 146.928L67.584 156.456L63.46 159.18C62.5758 159.756 61.8141 160.5 61.2189 161.371C60.6237 162.243 60.2066 163.223 59.9918 164.256C59.777 165.289 59.7685 166.354 59.9671 167.39C60.1656 168.426 60.5671 169.413 61.1485 170.293C61.7299 171.174 62.4797 171.93 63.3548 172.52C64.2298 173.109 65.2128 173.52 66.2472 173.728C67.2815 173.936 68.3468 173.937 69.3817 173.732C70.4165 173.526 71.4005 173.118 72.277 172.531L83.077 165.399L95.3 172.455L76.245 185.036C75.365 185.613 74.6075 186.359 74.016 187.229C73.4245 188.1 73.0106 189.079 72.7981 190.11C72.5855 191.141 72.5785 192.203 72.7775 193.237C72.9764 194.271 73.3773 195.255 73.9573 196.133C74.5372 197.011 75.2848 197.767 76.1572 198.356C77.0296 198.945 78.0097 199.356 79.0412 199.565C80.0727 199.774 81.1354 199.778 82.1684 199.576C83.2014 199.374 84.1844 198.971 85.061 198.388L110.791 181.399L121.991 187.862L93.555 203.646C92.6227 204.148 91.7993 204.831 91.1328 205.654C90.4662 206.477 89.9697 207.424 89.672 208.44C89.3743 209.457 89.2814 210.522 89.3986 211.574C89.5158 212.627 89.8409 213.646 90.3549 214.572C90.8689 215.498 91.5616 216.312 92.3929 216.969C93.2242 217.625 94.1776 218.109 95.1976 218.394C96.2176 218.679 97.284 218.758 98.335 218.628C99.386 218.497 100.401 218.16 101.32 217.634L138.145 197.191L148.99 203.453L136.533 209.612C135.584 210.074 134.736 210.718 134.038 211.509C133.339 212.299 132.804 213.22 132.463 214.218C132.122 215.216 131.981 216.272 132.05 217.325C132.118 218.378 132.394 219.406 132.862 220.352C133.329 221.297 133.979 222.141 134.774 222.835C135.569 223.528 136.494 224.057 137.494 224.392C138.494 224.727 139.551 224.861 140.603 224.785C141.655 224.71 142.682 224.428 143.625 223.954L152 219.813V292.183L143.625 288.042C142.682 287.568 141.655 287.286 140.603 287.211C139.551 287.135 138.494 287.269 137.494 287.604C136.494 287.939 135.569 288.468 134.774 289.161C133.979 289.855 133.329 290.699 132.862 291.644C132.394 292.59 132.118 293.618 132.05 294.671C131.981 295.724 132.122 296.78 132.463 297.778C132.804 298.776 133.339 299.697 134.038 300.487C134.736 301.278 135.584 301.922 136.533 302.384L148.99 308.543L138.145 314.805L101.32 294.362C100.401 293.843 99.3884 293.512 98.3406 293.386C97.2928 293.26 96.2305 293.343 95.2148 293.63C94.1992 293.917 93.2504 294.402 92.423 295.057C91.5955 295.712 90.9059 296.524 90.3937 297.447C89.8815 298.369 89.557 299.384 89.4387 300.433C89.3205 301.482 89.4109 302.543 89.7048 303.557C89.9986 304.57 90.4901 305.516 91.1509 306.339C91.8117 307.161 92.6288 307.845 93.555 308.351L121.986 324.134L110.786 330.597L85.056 313.608C83.2854 312.446 81.1265 312.034 79.0525 312.462C76.9785 312.889 75.1586 314.122 73.9918 315.889C72.8249 317.656 72.4064 319.814 72.8278 321.889C73.2493 323.964 74.4763 325.788 76.24 326.96L95.3 339.541L83.079 346.6L72.279 339.468C71.4025 338.881 70.4185 338.473 69.3837 338.267C68.3488 338.062 67.2835 338.063 66.2492 338.271C65.2148 338.479 64.2318 338.89 63.3568 339.479C62.4817 340.069 61.7319 340.825 61.1505 341.706C60.5691 342.586 60.1676 343.573 59.9691 344.609C59.7705 345.645 59.779 346.71 59.9938 347.743C60.2086 348.776 60.6257 349.756 61.2209 350.628C61.8161 351.499 62.5778 352.243 63.462 352.819L67.589 355.544L51.089 365.072C50.1719 365.593 49.3669 366.291 48.7205 367.125C48.0741 367.959 47.599 368.912 47.3226 369.93C47.0461 370.949 46.9738 372.011 47.1098 373.058C47.2458 374.104 47.5874 375.113 48.1149 376.027C48.6425 376.94 49.3455 377.741 50.1836 378.382C51.0217 379.022 51.9783 379.491 52.9983 379.761C54.0183 380.03 55.0815 380.096 56.1268 379.953C57.1722 379.81 58.1789 379.462 59.089 378.928L75.589 369.4L75.889 374.336C76.011 376.37 76.9045 378.28 78.387 379.678C79.8696 381.076 81.8295 381.855 83.867 381.857C84.028 381.857 84.191 381.857 84.354 381.842C86.4719 381.715 88.4525 380.751 89.8602 379.164C91.2678 377.577 91.9872 375.495 91.86 373.377L91.085 360.456L103.3 353.4L104.668 376.192C104.79 378.226 105.684 380.137 107.166 381.534C108.649 382.932 110.609 383.711 112.647 383.713C112.808 383.713 112.97 383.708 113.133 383.698C114.182 383.635 115.208 383.366 116.153 382.907C117.098 382.447 117.943 381.806 118.64 381.02C119.337 380.234 119.872 379.319 120.216 378.326C120.559 377.333 120.703 376.282 120.64 375.233L118.792 344.456L129.987 337.993L129.439 370.506C129.421 371.557 129.611 372.6 129.996 373.578C130.382 374.555 130.956 375.447 131.687 376.202C132.417 376.957 133.289 377.561 134.253 377.98C135.217 378.398 136.254 378.622 137.304 378.64H137.441C139.54 378.64 141.555 377.816 143.051 376.344C144.548 374.873 145.406 372.872 145.441 370.774L146.149 328.662L156.99 322.4L156.09 336.268C156.022 337.316 156.162 338.368 156.5 339.363C156.839 340.357 157.37 341.276 158.063 342.065C158.757 342.854 159.599 343.499 160.542 343.963C161.485 344.427 162.51 344.7 163.558 344.768C163.734 344.779 163.908 344.784 164.081 344.784C166.112 344.782 168.067 344.008 169.548 342.618C171.029 341.228 171.926 339.326 172.057 337.299L172.657 327.977L235.329 364.161L227.556 369.343C225.803 370.525 224.59 372.353 224.181 374.428C223.772 376.502 224.2 378.654 225.373 380.413C226.546 382.173 228.368 383.396 230.44 383.816C232.512 384.236 234.667 383.819 236.432 382.655L248 374.944V387.466L211.884 409.136C210.983 409.677 210.198 410.389 209.572 411.233C208.947 412.077 208.494 413.036 208.239 414.056C207.984 415.075 207.932 416.134 208.087 417.173C208.242 418.213 208.6 419.211 209.14 420.112C209.681 421.013 210.393 421.798 211.237 422.424C212.081 423.049 213.041 423.502 214.06 423.757C215.079 424.012 216.138 424.064 217.178 423.909C218.217 423.754 219.215 423.397 220.116 422.856L248 406.125V419.052L220.422 432.841C219.474 433.306 218.627 433.954 217.931 434.747C217.235 435.541 216.702 436.465 216.365 437.465C216.027 438.465 215.89 439.523 215.963 440.576C216.036 441.629 216.317 442.658 216.789 443.602C217.261 444.546 217.916 445.388 218.715 446.078C219.514 446.768 220.442 447.293 221.444 447.623C222.447 447.953 223.506 448.081 224.558 448C225.611 447.919 226.637 447.631 227.578 447.151L248 436.94V451.052L236.422 456.841C234.541 457.8 233.116 459.463 232.456 461.468C231.797 463.474 231.956 465.658 232.901 467.546C233.845 469.434 235.497 470.873 237.497 471.548C239.497 472.223 241.683 472.08 243.578 471.151L248 468.94V488C248 490.122 248.843 492.157 250.343 493.657C251.843 495.157 253.878 496 256 496C258.122 496 260.157 495.157 261.657 493.657C263.157 492.157 264 490.122 264 488V468.94L268.422 471.151C270.317 472.08 272.503 472.223 274.503 471.548C276.503 470.873 278.155 469.434 279.099 467.546C280.044 465.658 280.203 463.474 279.544 461.468C278.884 459.463 277.459 457.8 275.578 456.841L264 451.052V436.94L284.422 447.151C286.317 448.08 288.503 448.223 290.503 447.548C292.503 446.873 294.155 445.434 295.099 443.546C296.044 441.658 296.203 439.474 295.544 437.468C294.884 435.463 293.459 433.8 291.578 432.841L264 419.052V406.125L291.884 422.856C293.703 423.948 295.882 424.272 297.94 423.757C299.999 423.243 301.768 421.931 302.86 420.112C303.952 418.293 304.276 416.114 303.761 414.056C303.247 411.997 301.935 410.228 300.116 409.136L264 387.466V374.944L275.562 382.652C277.327 383.816 279.482 384.233 281.554 383.813C283.626 383.393 285.448 382.17 286.621 380.41C287.794 378.651 288.222 376.499 287.813 374.425C287.404 372.35 286.191 370.522 284.438 369.34L276.665 364.158L339.337 327.974L339.937 337.296C340.068 339.323 340.965 341.225 342.446 342.615C343.927 344.005 345.882 344.779 347.913 344.781C348.086 344.781 348.26 344.781 348.436 344.765C349.485 344.697 350.509 344.424 351.452 343.96C352.395 343.496 353.237 342.851 353.931 342.062C354.624 341.273 355.155 340.354 355.494 339.36C355.833 338.365 355.972 337.314 355.904 336.265L355.01 322.4L365.855 328.661L366.563 370.773C366.598 372.871 367.457 374.872 368.953 376.343C370.45 377.815 372.464 378.639 374.563 378.639H374.7C375.751 378.621 376.787 378.397 377.751 377.979C378.715 377.56 379.587 376.956 380.317 376.201C381.048 375.446 381.622 374.554 382.008 373.577C382.393 372.599 382.583 371.556 382.565 370.505L382.017 337.992L393.212 344.455L391.364 375.232C391.301 376.281 391.445 377.332 391.789 378.325C392.132 379.318 392.667 380.233 393.364 381.019C394.061 381.805 394.906 382.446 395.851 382.906C396.796 383.365 397.822 383.634 398.871 383.697C399.034 383.707 399.196 383.712 399.357 383.712C401.395 383.71 403.355 382.931 404.838 381.533C406.32 380.136 407.214 378.225 407.336 376.191L408.7 353.4L420.92 360.456L420.145 373.377C420.018 375.495 420.737 377.577 422.145 379.164C423.553 380.751 425.533 381.715 427.651 381.842C427.814 381.852 427.976 381.857 428.138 381.857C430.176 381.855 432.135 381.076 433.618 379.678C435.101 378.28 435.994 376.37 436.116 374.336L436.416 369.4L452.916 378.928C453.826 379.462 454.833 379.81 455.878 379.953C456.924 380.096 457.987 380.03 459.007 379.761C460.027 379.491 460.983 379.022 461.821 378.382C462.66 377.741 463.363 376.94 463.89 376.027C464.418 375.113 464.759 374.104 464.895 373.058C465.031 372.011 464.959 370.949 464.682 369.93C464.406 368.912 463.931 367.959 463.285 367.125C462.638 366.291 461.833 365.593 460.916 365.072V365.069ZM310.627 326.075L307.227 294.812L336 311.424L310.627 326.075ZM176 311.424L204.775 294.812L201.375 326.075L176 311.424ZM201.375 185.924L204.775 217.184L176 200.574L201.375 185.924ZM336 200.574L307.229 217.185L310.629 185.925L336 200.574ZM315.23 280.957L344 268.271V297.571L315.23 280.957ZM260.73 297.545C259.359 296.541 257.704 296 256.004 296C254.305 296 252.649 296.541 251.278 297.545L217.919 321.966L222.388 280.866C222.572 279.177 222.213 277.473 221.363 276.001C220.513 274.529 219.217 273.366 217.662 272.681L179.829 256L217.658 239.32C219.213 238.635 220.509 237.472 221.359 236C222.209 234.528 222.568 232.824 222.384 231.135L217.915 190.035L251.274 214.456C252.645 215.46 254.301 216.001 256 216.001C257.7 216.001 259.355 215.46 260.726 214.456L294.085 190.035L289.616 231.135C289.432 232.824 289.791 234.528 290.641 236C291.491 237.472 292.787 238.635 294.342 239.32L332.171 256L294.342 272.68C292.787 273.365 291.491 274.528 290.641 276C289.791 277.472 289.432 279.176 289.616 280.865L294.085 321.965L260.73 297.545ZM315.23 231.045L344 214.428V243.728L315.23 231.045ZM264 192.229V159.005L289.374 173.654L264 192.229ZM248 192.229L222.626 173.654L248 159.005V192.229ZM196.775 231.042L168 243.729V214.429L196.775 231.042ZM196.775 280.957L168 297.568V268.268L196.775 280.957ZM248 319.771V353L222.626 338.351L248 319.771ZM264 319.771L289.374 338.346L264 353V319.771Z" fill="url(#paint0_linear_15_71924)"/>
    <defs>
    <linearGradient id="paint0_linear_15_71924" x1="91.884" y1="420.114" x2="420.116" y2="91.882" gradientUnits="userSpaceOnUse">
    <stop stop-color="#41DFD0"/>
    <stop offset="1" stop-color="#EE83EF"/>
    </linearGradient>
    </defs>
    </svg>
    `
    snowFlake.style.left = `${Math.random() * window.innerWidth}px`
    snowFlake.style.top = `${Math.random() * window.innerHeight}px`
    snowFlake.style.animationDuration = `${Math.random() * 3 + 2}s` // between 2 - 5 seconds
    snowFlake.style.width = `${Math.random() * 12 + 10}px`
    snowFlake.style.height = `${Math.random() * 12 + 10}px`
    snowFlake.style.opacity = Math.random()
    snowFlake.style.fontSize = `${Math.random() * 10 + 10}px`
    document.getElementById('root').appendChild(snowFlake)

    setTimeout(() => {
      snowFlake.remove()
    }, 5000)
  }

  useEffect(() => {
    setInterval(createSnowFlake, 500)
  }, [])

  useEffect(() => {
    const loaderEl = document.getElementById('loader')

    if (loaderEl) {
      loaderEl.classList.add('available')
      setTimeout(() => {
        loaderEl.outerHTML = ''
      }, 1000)
    }
  }, [])

  useEffect(() => {
    (async () => {
      if (accessToken && !authenticated) {
        try {
          const me = await authMe()

          dispatch(authActions.loginSuccess(me))
          dispatch(authActions.finishLoading())
        } catch (e) {
          dispatch(authActions.logout())
        }
      }
    })()
  }, [authenticated]) // eslint-disable-line

  useEffect(() => {
    if (error) {
      alert.error(error.toString(), {
        onClose: () => {
          dispatch(errorsActions.clearErrors())
        },
      })
    }
  }, [error]) // eslint-disable-line

  useEffect(() => {
    if (message && type) {
      alert.show(message.toString(), {
        type,
        onClose: () => {
          dispatch(alertsActions.clearAlerts())
        },
      })
    }
  }, [message, type]) // eslint-disable-line

  const isMinimalFooter = _some(minimalFooterPages, (page) => _includes(location.pathname, page))

  return (
    (!accessToken || !loading) && (
      // eslint-disable-next-line react/jsx-no-useless-fragment
      <Suspense fallback={<></>}>
        <Header authenticated={authenticated} theme={theme} />
        <ScrollToTop>
          <Selfhosted>
            <Suspense fallback={<Fallback theme={theme} isMinimalFooter={isMinimalFooter} />}>
              <Switch>
                <Route path={routes.main} component={MainPage} exact />
                <Route path={routes.signin} component={SignIn} exact />
                <Route path={routes.signup} component={SignUp} exact />
                <Route path={routes.dashboard} component={Dashboard} exact />
                <Route path={routes.user_settings} component={UserSettings} exact />
                <Route path={routes.verify} component={VerifyEmail} exact />
                <Route path={routes.change_email} component={VerifyEmail} exact />
                <Route path={routes.reset_password} component={ForgotPassword} exact />
                <Route path={routes.new_password_form} component={CreateNewPassword} exact />
                <Route path={routes.new_project} component={ProjectSettings} exact />
                <Route path={routes.project_settings} component={ProjectSettings} exact />
                <Route path={routes.project} component={ViewProject} exact />
                <Route path={routes.billing} component={Billing} exact />
                <Route path={routes.docs} component={Docs} exact />
                <Route path={routes.contact} component={Contact} exact />
                <Route path={routes.features} component={Features} exact />
                <Route path={routes.privacy} component={Privacy} exact />
                <Route path={routes.terms} component={Terms} exact />
                <Route path={routes.confirm_share} component={ConfirmShare} exact />
                <Route path={routes.about} component={About} exact />
                <Route path='*' component={NotFound} />
              </Switch>
            </Suspense>
          </Selfhosted>
        </ScrollToTop>
        <Footer minimal={isMinimalFooter} authenticated={authenticated} />
      </Suspense>
    )
  )
}

export default App
